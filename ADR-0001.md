# ADR-0001: Phase A Defaults (Corngr-ERP / Antigravity)

**Status:** Accepted  
**Date:** 2026-02-27  
**Owner:** Antigravity Engineering  
**Scope:** Phase A baseline (Local-first ERP-Grid)

## Context

Corngr-ERP is a local-first, CRDT-driven ERP-Grid where business truth is represented as signed mutations over Yjs/yrs fragments, anchored into a Merkle-chained audit log. Phase A must ship an end-to-end baseline that is deployable for SMEs with minimal setup friction, while preserving cryptographic auditability and offline-first operation.

This ADR captures Phase A default decisions across:
- Chart of Accounts (CoA) onboarding
- Local LLM selection for CAIO
- Primary Node deployment form factor
- Partial fulfillment policy for posting (`post_tx`)
- Multi-site fields (`branch_id` / `site_id`) phasing

## Decision

### 1) Default Chart of Accounts (CoA)
**Decision:** Ship with default CoA templates; allow "blank" only as an advanced option.

**Phase A default behavior**
- On org creation, user selects one of:
  1. **General SME (AU GST)**
  2. **Services (low inventory)**
  3. **Product/Light Manufacturing (inventory + COGS)**
- "Blank CoA" is available behind an **Advanced** toggle.

**Rationale**
- Minimizes onboarding friction and reduces misconfiguration risk for posting rules.
- Templates are just fragments and can be edited; all changes remain time-travelable and audit-ready.

---

### 2) Local LLM Model/Size for Phase A CAIO
**Decision:** Default to a small local model (3B–4B class) with strict grounding; provide opt-in "power" modes.

**Phase A default behavior**
- CAIO runs locally using a **3B–4B instruct model** (via Candle/llama-edge).
- CAIO output is **proposal-only** (never finalizes transactions).
- All CAIO insights must be **grounded**:
  - derived from Merkle audit log entries and/or referenced fragments
  - must support "drill-to-source"; otherwise CAIO returns a "needs signed data" response.
- UI provides: **Fast / Balanced / Powerful**
  - "Powerful" (7B/8B+) only enabled if device capability checks pass.

**Rationale**
- Reliability comes from constraints and grounding more than raw parameters.
- Keeps Phase A deployable on representative SME hardware.

---

### 3) Primary Node Deployment Form Factor
**Decision:** Phase A Primary Node is an in-app mode; headless service is Phase B.

**Phase A default behavior**
- The desktop app includes a **"Primary Node Mode"** toggle:
  - runs canonical anchor services on the local network
  - maintains canonical audit chain
  - relays sync for satellites
- Cockpit displays Primary health: reachable, last seen, pending outbox, canonical head hash.

**Phase B plan**
- Add a **headless daemon** (Rust service) + admin UI.
- Provide Docker packaging for power users.

**Rationale**
- Lowest-friction deployment for SMEs (office PC/Mac mini/Nuc).
- Defers ops complexity without blocking correctness.

---

### 4) Partial Fulfillment Policy on `post_tx`
**Decision:** Support partial fulfillment, but never silently post mismatched physical/financial state; enforce explicit, policy-gated rules.

**Phase A default behavior**
- Posting must validate fulfillment state per tx type:
  - **invoice_out**
    - allowed to post when at least one linked shipment move exists
    - postings must reflect shipped quantities/valuation (if COGS recognition enabled)
    - remaining quantities remain outstanding and visible as "partial"
  - **stock_receipt**
    - partial receipt allowed; postings reflect received value; remainder stays open
- Hard invariants:
  - sum(|moves.qty_delta|) ≤ line.qty (unless overship policy explicitly enabled)
  - inventory effect direction must match line inventory_effect
- UX:
  - "Partial" badges and remaining outstanding quantities surfaced in Grid/Cockpit.

**Rationale**
- Matches SME operational reality while preserving signed integrity.
- Prevents "ERP drift" where finance and warehouse disagree.

---

### 5) `branch_id` / `site_id` in Phase A vs Phase B
**Decision:** Include optional `branch_id/site_id` fields in Phase A schema, but keep multi-site logic minimal until Phase B.

**Phase A default behavior**
- Add optional fields:
  - `tx:{id}:hdr.site_id` (default `"primary"`)
  - `invmove:{id}.site_id` (default `"primary"`)
- Do not require complex cross-site ABAC; keep policies simple.

**Phase B plan**
- Full multi-site: per-site inventory, per-site approvals, inter-site transfers, stronger ABAC by site.

**Rationale**
- Cheap to include now; expensive to retrofit later.
- Preserves forward compatibility without increasing Phase A scope significantly.

## Consequences

**Positive**
- SMEs can be productive quickly with safe defaults.
- Phase A remains deployable on typical hardware and networks.
- Strong compliance posture: signed reality + drill-to-source + proposal-only AI.
- Forward-compatible schema for multi-site and ecosystem expansion.

**Trade-offs / Risks**
- CoA templates may not perfectly fit all industries; mitigated via editable fragments and later marketplace lenses.
- Small LLM may be less fluent; mitigated via grounding and narrow task scope (briefings + proposals).
- In-app Primary Mode relies on an always-on workstation until Phase B daemon is delivered.
- Partial fulfillment adds complexity to posting checks; mitigated with strict invariants and clear UX.

## Follow-ups

1. Define the three CoA templates (accounts + posting rules) as seed fragments.
2. Implement CAIO grounding contract: every insight must reference audit entries/fragments.
3. Implement Primary Mode toggle + Cockpit "Node Health Map".
4. Implement `post_tx` fulfillment validation matrix for Phase A tx types.
5. Add `site_id` fields to schema and propagate through create_tx / create_invmove APIs.

---
**End of ADR-0001**
